var Gkn = require('gkn-js'),
	Q = require('q');

module.exports.debuglog = function(msg) {
	/**
	* Logs output to the console, if DEBUGLOGGING is enabled
	**/

	if (typeof msg === 'object') {
		msg = JSON.stringify(msg);
	}

    // if (DEBUGLOGGING) {
    	var now = new Date().toISOString().replace(/T/, ' ').replace(/\..+/, '');
		console.log(now + ',' + 'DEBUG,' + msg);
	// }
}

module.exports.log = function(msg) {
	/**
	* Logs output to the console
	**/

	if (typeof msg === 'object') {
		msg = JSON.stringify(msg);
	}
   	var now = new Date().toISOString().replace(/T/, ' ').replace(/\..+/, '');
	console.warn(now + ',' + 'WARN,' + msg);
}

module.exports.powershell = function(script, paramsAsString) {
	/**
	* Runs a PowerShell script and returns output as standard output object { success, status: 204, caller, data }
	*
	* script = Name of PowerShell script in node-api/powershell/ directory with .ps1 file extension
	* paramsAsString = Script parameters as a single string
	*
	* Returns standard output object { success, status: 204, caller, data }
	*
	**/
	var exec = require('child_process').exec,
		deferred = Q.defer();

	Gkn.Common.debuglog('powershell script: ' + script + ', parameters: ' + paramsAsString);
	var command = 'powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command "& c:\\node-api\\powershell\\' + script + '" ' 
		+ paramsAsString;
	Gkn.Common.debuglog(command);
	
	exec(command, function(error, stdout, stderr) {
		Gkn.Common.debuglog(error, stdout, stderr);
		if (error) {
			deferred.reject({ success: false, status: 400, caller: 'function.js>powershell', data: stderr });
			return;
		}

		deferred.response({ success: true, status: 200, caller: 'function.js>powershell', data: stdout });
		return;
	});

	return deferred.promise;
}